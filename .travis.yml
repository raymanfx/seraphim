language: cpp

os: linux
dist: bionic
sudo: required

services:
  - docker

#cache:
#  bundler: true
#  directories:
#    - $HOME/docker

#before_cache:
#  # Save tagged docker images
#  - >
#    mkdir -p $HOME/docker && docker images -a --filter='dangling=false' --format '{{.Repository}}:{{.Tag}} {{.ID}}'
#    | xargs -n 2 -t sh -c 'test -e $HOME/docker/$1.tar.gz || docker save $0 | gzip -2 > $HOME/docker/$1.tar.gz'

#before_install:
#  # Load cached docker images
#  - >
#    if [[ -d $HOME/docker ]] && [[ ! -z $HOME/docker ]]; then ls $HOME/docker/*.tar.gz
#    | xargs -I {file} sh -c "zcat {file} | docker load"; fi

before_script:
  - sudo chown -R 1000 .

install:
  - >
    docker build -t builder .

jobs:
  include:
    - stage: lint
      script:
        - >
          docker run -v $(pwd):$(pwd) -w $(pwd) -it builder make lint
    - stage: build
      script:
        - >
          docker run -v $(pwd):$(pwd) -w $(pwd) -it builder make build

stages:
  - name: lint
    if: branch = foo
  - build
